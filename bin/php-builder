#!/bin/bash

# http://stackoverflow.com/a/4025065
function vercomp {
  if [[ $1 == $2 ]]
  then
      return 0
  fi
  local IFS=".-"
  local i ver1=($1) ver2=($2)
  # fill empty fields in ver1 with zeros
  for ((i=${#ver1[@]}; i<${#ver2[@]}; i++))
  do
      ver1[i]=0
  done
  # if the last part is not a number (version variant), we dont want to select it automatically
  if ! [[ ${ver2[$((${#ver2[@]}-1))]} =~ ^[0-9]+$ ]]
  then
      return 1
  fi
  for ((i=0; i<${#ver1[@]}; i++))
  do
      if [[ -z ${ver2[i]} ]]
      then
          # fill empty fields in ver2 with zeros
          ver2[i]=0
      fi
      if ((10#${ver1[i]} > 10#${ver2[i]}))
      then
          return 1
      fi
      if ((10#${ver1[i]} < 10#${ver2[i]}))
      then
          return 2
      fi
  done
  return 0
}

if [[ "$#" -lt 1 ]] || [[ "$#" -gt 2 ]]; then
    echo "Usage : $0 <version> [<variant>]"
    exit 1
fi

VERSION="$1"
cd $HOME/Work/php-src
(git fetch && git checkout --force "refs/tags/php-$VERSION") > /dev/null


BASE_DIR="/usr/local/php/$VERSION"
if ! [[ -z $2 ]]; then
    BASE_DIR="$BASE_DIR-$2"
fi

CONFIGURE_OPTIONS="--localstatedir=/usr/local/var --with-iconv-dir=/usr --enable-dba --with-ndbm=/usr --enable-exif \
--enable-soap --enable-wddx --enable-ftp --enable-sockets --enable-zip --enable-pcntl --enable-shmop \
--enable-sysvsem --enable-sysvshm --enable-sysvmsg --enable-mbstring --enable-mbregex --enable-bcmath \
--enable-calendar --with-zlib=/usr/local/opt/zlib --with-ldap --with-ldap-sasl=/usr --with-xmlrpc \
--with-kerberos=/usr --with-xsl=/usr --with-gd --enable-gd-native-ttf --with-freetype-dir=/usr/local/opt/freetype \
--with-jpeg-dir=/usr/local/opt/jpeg --with-png-dir=/usr/local/opt/libpng --with-gettext=/usr/local/opt/gettext \
--with-snmp=/usr --with-libedit --with-mhash --with-curl --with-bz2=/usr --with-openssl=/usr/local/opt/openssl \
--enable-fpm --with-fpm-user=_www --with-fpm-group=_www --with-gmp=/usr/local/opt/gmp \
--with-mysql-sock=/tmp/mysql.sock --with-mysqli=mysqlnd --with-mysql=mysqlnd --with-pdo-mysql=mysqlnd \
--with-pgsql=/usr/local/opt/postgresql --with-pdo-pgsql=/usr/local/opt/postgresql \
--with-iodbc --with-pdo-odbc=generic,/usr,iodbc \
--prefix=${BASE_DIR} \
--sysconfdir=${BASE_DIR}/etc \
--mandir=${BASE_DIR}/share/man \
--with-config-file-path=${BASE_DIR}/etc \
--with-config-file-scan-dir=${BASE_DIR}/etc/conf.d"

if [[ "x$2" == "xdebug" ]]; then
    CONFIGURE_OPTIONS="$CONFIGURE_OPTIONS \
--enable-zend-signals --enable-debug --enable-dtrace --enable-maintainer-zts"
fi

vercomp $VERSION "5.4.0"
if [[ $? == 2 ]]; then
    export PHP_AUTOCONF="/usr/local/autoconf-2.59/bin/autoconf"
fi

./buildconf --force > /dev/null \
  && \
./configure $CONFIGURE_OPTIONS > /dev/null \
 && \
make clean > /dev/null \
 && \
make > /dev/null  2>&1 \
 && \
make install
